# 性能优化的思路

## 性能优化要解决什么问题？

**从输入url到呈现页面如何更快**

## 分析思路

基于一个著名的面试题

从输入url到呈现页面中间发生了什么？

answer: 

1. 根据url去服务器的IP地址

2. 建立TCP链接(三次握手)

3. 发送HTTP请求

4. 服务器处理请求并返回HTTP报文

5. 浏览器解析并渲染页面
 
6. 断开链接

## 分析过程

当我们输入baidu.com时，会做这样一件事

```
baidu.com ---(DNS解析)---> IP
```

那么，我们可以通过优化DNS来达到性能优化，比如更多的DNS服务器，或者配置本地host

当我们找到IP之后，我们便会从服务器请求我们需要的资源(html,css,js,图片)，假设有n个html，css，js

```
客户端 ---(TCP) --- 服务器

得到html n次TCP链接
得到css n次TCP链接
得到js n次TCP链接
······
```
    
多次的TCP链接是一种浪费，因此我们可以在这个层面进行优化，

```
链接开始
  得到html
  得到css
  得到js
  ······
链接断开
```

这样就可以做到建立一次TCP链接完成所有的请求，这种方式也叫做连接复用(keep-alive)

同时，我们需要去后端读取数据库，例如

```
客户端 ------> baidu.com ------> 读取数据库
```

因此可以对SQL进行优化

当baidu.com为我们返回内容时，响应时间可以认为是

```
时间 = 下载量 / 速度
```

因此可以通过减少下载量和增大速度来缩短响应时间

但是增大速度智能通过增大带宽来实现

因此可以从减少下载量身上做文章(压缩，例如采用Gzip)

当我们下载完毕后，需要把页面展示出来，这就需要解析html、css、js，

展示html无法优化，但是在css和js方面均可以优化

对于css而言

假如我们有如下的代码

```html
<h1>i am h1</h1>
```

```css
h1{color: red}
h1{color: blue}
```

我们需要渲染h1的文字标签为红色，然后在渲染h1的文字为蓝色

这是一种性能浪费(渲染需要付出一定的代价)

因此我们可以将相同选择器的css代码进行合并

对于js而言

我们可以参考一下用户习惯就可以知道我们可以先把用户看得到的内容渲染出来，再去加载鼠标动作

也就是说我们可以先加载css，再加载js(这也是为啥css放在head，js放在body后面)

既然用户先看再动，因此我们可以先不加载第二屏(懒加载)

对于用户大概率会点击的页面，我们也可以提前加载(预加载)

关闭浏览器后

第二天，我们要再次打开这个网页，发现上述过程还要执行一遍，加载了相同的资源

这也是一种浪费，因此 我们可以考虑缓存下来资源

在链接建立的过程中，我们使用了DNS、TCP、HTTP

其中DNS可以做缓存，TCP无法做缓存，HTTP也可以做缓存

(关于缓存的问题会在之后的文章介绍)

假设我们的页面有一个html、10个css以及20个js

我们要请求这些东西

```
客户端 ------> baidu.com (get html)
客户端 ------> baidu.com (get css) * 10
客户端 ------> baidu.com (get js) * 20
```

一共需要发31次请求

怎么处理？ 我可以一次发31个请求

但是服务器的并发是有限制的

所以浏览器会对同时发请求有个数限制(比如一次只能发10个)

所以我们可以把不同的资源 放到不同的域名中 例如

```
------------------------------------------- 一次
客户端 ------> baidu.com (get html)
客户端 ------> css.baidu.com (get css) 并发发10个请求
客户端 ------> js.baidu.com (get js) 并发发10个请求
-------------------------------------------  二次
客户端 ------> js.baidu.com (get js) 并发发10个请求
```

因此一共需要发两次请求就可以了

同时这么做也可以做到cookie free 因为只有html请求需要带cookie，css、js、图片均无cookie

因此可以把cookie发送次数由31降为1

以上就是分析过程

## 总结

性能优化可能从一下的点来考虑

1. DNS 优化(配置host文件等)
2. TCP连接复用(keep-alive)
3. SQL优化
4. 压缩(开启Gzip)
5. 展示优化

    * css: 重复的选择器合并 & 先加载css 再加载js
    * js: 先不加载第二屏(懒加载) & 提前加载多数用户可能加载的下一页(预备加载)
    
6. 浏览器缓存(DNS缓存及HTTP缓存)
7. 把资源(图片、css、js)放到CDN中
8. 使用CDN域名